name: Build and deploy Marp slides

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '**/*.css'
      - '**/diagrams/**'
      - '**/images/**'
      - 'Makefile'
      - 'presentation.mk'
      - '.github/workflows/slides.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Build slides (HTML + PDF)
        run: make

      - name: Prepare distribution directory
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          presentations=()
          for md in */*.md; do
            [ -f "$md" ] || continue
            dir="${md%%/*}"
            base="$(basename "$md" .md)"
            html="$dir/$base.html"
            pdf="$dir/$base.pdf"

            [ -f "$html" ] || continue

            mkdir -p "dist/$dir"
            cp "$html" "dist/$dir/index.html"
            if [ -f "$pdf" ]; then
              cp "$pdf" "dist/$dir/"
            fi

            for assets in diagrams images; do
              if [ -d "$dir/$assets" ]; then
                mkdir -p "dist/$dir/$assets"
                cp -R "$dir/$assets/." "dist/$dir/$assets/"
              fi
            done

            presentations+=("$dir|$base")
          done

          {
            echo '<!doctype html>'
            echo '<html lang="en">'
            echo '<head>'
            echo '  <meta charset="UTF-8" />'
            echo '  <meta name="viewport" content="width=device-width, initial-scale=1.0" />'
            echo '  <title>Presentations</title>'
            echo '  <style>body{font-family:Arial,sans-serif;margin:2rem;}h1{margin-bottom:0.5rem;}ul{line-height:1.8;}li{margin-bottom:0.25rem;}</style>'
            echo '</head>'
            echo '<body>'
            echo '  <h1>Available presentations</h1>'
            echo '  <ul>'

            for entry in "${presentations[@]}"; do
              dir="${entry%%|*}"
              base="${entry##*|}"
              pdf_path="./${dir}/${base}.pdf"

              echo -n "    <li><strong>${dir}</strong>: <a href=\"./${dir}/\">HTML</a>"
              if [ -f "dist/${dir}/${base}.pdf" ]; then
                echo " | <a href=\"${pdf_path}\">PDF</a></li>"
              else
                echo '</li>'
              fi
            done

            echo '  </ul>'
            echo '</body>'
            echo '</html>'
          } > dist/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./dist
